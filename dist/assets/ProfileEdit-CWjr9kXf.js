import{r as e,j as a,ci as s,cz as r,t,aC as i,bR as l}from"./vendor-react-Bu_1CUKu.js";import{q as o,A as n,b as c,c as u,B as d,s as m,L as p,I as f,T as v}from"./index-QnHMPHoX.js";import"./vendor-CaMlX_x-.js";import"./vendor-date-fns-BCWkNTJO.js";const h=({currentImageUrl:t,onUploadComplete:i})=>{const[l,p]=e.useState(!1),f=e.useRef(null),{toast:v}=o();return a.jsxs("div",{className:"flex flex-col items-center gap-4",children:[a.jsxs(n,{className:"h-32 w-32 ring-2 ring-purple-100 shadow-lg",children:[t?a.jsx(c,{src:t,alt:"Foto de perfil"}):null,a.jsx(u,{children:a.jsx(s,{className:"h-12 w-12"})})]}),a.jsx("input",{type:"file",ref:f,className:"hidden",accept:"image/*",onChange:async e=>{var a;try{p(!0);const s=null==(a=e.target.files)?void 0:a[0];if(!s)return void p(!1);if(!s.type.startsWith("image/"))return v({variant:"destructive",title:"Erro no upload",description:"Por favor, selecione apenas arquivos de imagem."}),void p(!1);if(s.size>5242880)return v({variant:"destructive",title:"Arquivo muito grande",description:"O tamanho máximo permitido é 5MB."}),void p(!1);const r=s.name.split(".").pop(),t=`${crypto.randomUUID()}.${r}`,{data:l,error:o}=await m.storage.from("profile_images").upload(t,s,{cacheControl:"3600",upsert:!1});if(o)return v({variant:"destructive",title:"Erro no upload",description:o.message||"Não foi possível fazer o upload da imagem."}),void p(!1);const{data:{publicUrl:n}}=m.storage.from("profile_images").getPublicUrl(t);i(n),v({title:"Sucesso!",description:"Sua foto de perfil foi atualizada."})}catch(s){v({variant:"destructive",title:"Erro no upload",description:s.message||"Não foi possível fazer o upload da imagem."})}finally{p(!1)}}}),a.jsxs(d,{variant:"outline",className:"gap-2",disabled:l,onClick:e=>{e.preventDefault(),e.stopPropagation(),f.current&&f.current.click()},type:"button",children:[a.jsx(r,{className:"h-4 w-4"}),l?"Enviando...":"Alterar foto"]})]})};function x(){const[s,r]=e.useState(!0),[n,c]=e.useState(!1),[u,x]=e.useState({username:"",full_name:"",avatar_url:null,bio:""}),g=t(),{toast:j}=o();e.useEffect((()=>{(async()=>{try{const{data:{user:e}}=await m.auth.getUser();if(!e)return;const{data:a}=await m.storage.listBuckets();if(!(null==a?void 0:a.some((e=>"profile_images"===e.name)))){const{error:e}=await m.storage.createBucket("profile_images",{public:!0})}}catch(e){}})(),N()}),[]);const N=async()=>{var e,a;try{r(!0);const{data:{user:s}}=await m.auth.getUser();if(!s)return void g("/auth");const{data:t,error:i}=await m.from("profiles").select("*").eq("id",s.id).maybeSingle();if(i||!t){const{error:r}=await m.from("profiles").insert([{id:s.id,username:(null==(e=s.email)?void 0:e.split("@")[0])||"",full_name:""}]);if(r)throw r;x({username:(null==(a=s.email)?void 0:a.split("@")[0])||"",full_name:"",avatar_url:null,bio:""})}else x({username:t.username||"",full_name:t.full_name||"",avatar_url:t.avatar_url,bio:t.bio||""})}catch(s){j({variant:"destructive",title:"Erro",description:"Não foi possível carregar os dados do perfil."})}finally{r(!1)}};return s?a.jsx("div",{className:"flex min-h-screen items-center justify-center",children:a.jsx(i,{className:"h-8 w-8 animate-spin text-purple-500"})}):a.jsxs("div",{className:"container max-w-2xl py-8 px-4",children:[a.jsxs(d,{variant:"ghost",className:"mb-6 gap-2",onClick:()=>g(-1),type:"button",children:[a.jsx(l,{className:"h-4 w-4"}),"Voltar"]}),a.jsx("h1",{className:"text-2xl font-bold mb-8",children:"Editar Perfil"}),a.jsxs("form",{onSubmit:async e=>{e.preventDefault(),c(!0);try{const{data:{user:e}}=await m.auth.getUser();if(!e)return void g("/auth");const{error:a}=await m.from("profiles").update({username:u.username,full_name:u.full_name,avatar_url:u.avatar_url,bio:u.bio}).eq("id",e.id);if(a)throw a;j({title:"Perfil atualizado",description:"Suas alterações foram salvas com sucesso."}),g("/")}catch(a){j({variant:"destructive",title:"Erro",description:"Não foi possível atualizar o perfil."})}finally{c(!1)}},className:"space-y-8",children:[a.jsx("div",{className:"flex justify-center mb-8",children:a.jsx(h,{currentImageUrl:u.avatar_url,onUploadComplete:e=>x((a=>({...a,avatar_url:e})))})}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"username",children:"Nome de usuário"}),a.jsx(f,{id:"username",value:u.username,onChange:e=>x((a=>({...a,username:e.target.value}))),placeholder:"@username"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"fullName",children:"Nome completo"}),a.jsx(f,{id:"fullName",value:u.full_name,onChange:e=>x((a=>({...a,full_name:e.target.value}))),placeholder:"Seu nome completo"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"bio",children:"Biografia"}),a.jsx(v,{id:"bio",value:u.bio,onChange:e=>x((a=>({...a,bio:e.target.value}))),placeholder:"Conte um pouco sobre você...",className:"min-h-[100px]"})]})]}),a.jsxs(d,{type:"submit",className:"w-full gap-2",disabled:n,children:[n&&a.jsx(i,{className:"h-4 w-4 animate-spin"}),n?"Salvando...":"Salvar alterações"]})]})]})}export{x as default};
